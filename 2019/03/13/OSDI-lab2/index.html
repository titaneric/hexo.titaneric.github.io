<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">










  <meta name="google-site-verification" content="RQtmPJShc9hc9WFJsoPCJy1PN9k4Yc6lm6Oz9iYNyM0">

















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=6.7.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.7.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.7.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.7.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="OSDI lab IIObjective Learn how to build a customized BIOS and show some message on system startup. Understand kernel booting flow and boot a ‘hello world’ program. Learn how to use BIOS interrupt call">
<meta name="keywords" content="course,os">
<meta property="og:type" content="article">
<meta property="og:title" content="OSDI-lab2">
<meta property="og:url" content="http://titaneric.github.io/2019/03/13/OSDI-lab2/index.html">
<meta property="og:site_name" content="Playground">
<meta property="og:description" content="OSDI lab IIObjective Learn how to build a customized BIOS and show some message on system startup. Understand kernel booting flow and boot a ‘hello world’ program. Learn how to use BIOS interrupt call">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://i.imgur.com/J0M7dAD.png">
<meta property="og:image" content="https://i.imgur.com/v1dMZr5.png">
<meta property="og:image" content="https://i.imgur.com/hwRLd1Z.png">
<meta property="og:image" content="https://i.imgur.com/DjL3gC2.png">
<meta property="og:image" content="https://i.imgur.com/biwIcIa.png">
<meta property="og:image" content="https://i.imgur.com/ejJFhn5.png">
<meta property="og:image" content="https://i.imgur.com/KB682J1.png">
<meta property="og:image" content="https://i.imgur.com/WGZwVkx.png">
<meta property="og:updated_time" content="2019-03-25T04:58:44.791Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OSDI-lab2">
<meta name="twitter:description" content="OSDI lab IIObjective Learn how to build a customized BIOS and show some message on system startup. Understand kernel booting flow and boot a ‘hello world’ program. Learn how to use BIOS interrupt call">
<meta name="twitter:image" content="https://i.imgur.com/J0M7dAD.png">






  <link rel="canonical" href="http://titaneric.github.io/2019/03/13/OSDI-lab2/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>OSDI-lab2 | Playground</title>
  




  <script async src="//www.googletagmanager.com/gtag/js?id=UA-132691301-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-132691301-1');
  </script>









  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Playground</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Just my little stuff here</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

  <a href="https://github.com/titaneric" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://titaneric.github.io/2019/03/13/OSDI-lab2/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Eric Huang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Playground">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">OSDI-lab2

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-03-13 15:04:11" itemprop="dateCreated datePublished" datetime="2019-03-13T15:04:11+00:00">2019-03-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-03-25 04:58:44" itemprop="dateModified" datetime="2019-03-25T04:58:44+00:00">2019-03-25</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="OSDI-lab-II"><a href="#OSDI-lab-II" class="headerlink" title="OSDI lab II"></a>OSDI lab II</h1><h2 id="Objective"><a href="#Objective" class="headerlink" title="Objective"></a>Objective</h2><ul>
<li>Learn how to build a customized BIOS and show some message on system startup.</li>
<li>Understand kernel booting flow and boot a ‘hello world’ program.</li>
<li>Learn how to use BIOS interrupt call to do I/O tasks.</li>
<li>Learn how to modify linux-0.11 bootsect.s and the build system to create a multiboot kernel image.</li>
</ul>
<a id="more"></a>
<hr>
<h2 id="Lab2-1-Build-SEABIOS-add-some-message-before-system-startup"><a href="#Lab2-1-Build-SEABIOS-add-some-message-before-system-startup" class="headerlink" title="Lab2.1 - Build SEABIOS, add some message before system startup"></a>Lab2.1 - Build SEABIOS, add some message before system startup</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://git.seabios.org/seabios.git seabios</span><br><span class="line"><span class="built_in">cd</span> seabios/</span><br><span class="line">make menuconfig</span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<p>Print message in <code>enable_vga_console</code> function in <code>src/bootsplash.c</code>.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">enable_vga_console(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    dprintf(<span class="number">1</span>, <span class="string">"Turning on vga text mode console\n"</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bregs</span> <span class="title">br</span>;</span> </span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Enable VGA text mode */</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;br, <span class="number">0</span>, <span class="keyword">sizeof</span>(br));</span><br><span class="line">    br.ax = <span class="number">0x0003</span>;</span><br><span class="line">    call16_int10(&amp;br);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"This is OSDI lab2.\n"</span>);</span><br><span class="line">    <span class="comment">// Write to screen.</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"SeaBIOS (version %s)\n"</span>, VERSION);</span><br><span class="line">    display_uuid();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Use the qemu <code>-bios</code> option to load customized BIOS.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -m 16M -boot a -fda Image -hda osdi.img -bios seabios/out/bios.bin</span><br></pre></td></tr></table></figure></p>
<p>Because the customized BIOS is part of our lab, so I push it to new repo and add the <strong>submodule</strong> to <code>osdi</code>.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git submodule add bios-url bios-in-osdi-path</span><br></pre></td></tr></table></figure></p>
<p>After that, I can update the customized BIOS even though we develop the BIOS and OSDI at different repo using the following command.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git submodule update bios-name</span><br></pre></td></tr></table></figure></p>
<hr>
<h2 id="Lab2-2-Add-image-before-system-startup"><a href="#Lab2-2-Add-image-before-system-startup" class="headerlink" title="Lab2.2 - Add image before system startup"></a>Lab2.2 - Add image before system startup</h2><p>We want to load the image when BIOS is loading.</p>
<p>Firstly, we want to find which function can help us to do that.<br>There is a function called <code>enable_bootsplash</code> @ <code>src/bootsplash.c</code>.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">enable_bootsplash(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!CONFIG_BOOTSPLASH)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">/* splash picture can be bmp or jpeg file */</span></span><br><span class="line">    dprintf(<span class="number">3</span>, <span class="string">"Checking for bootsplash\n"</span>);</span><br><span class="line">    u8 type = <span class="number">0</span>; <span class="comment">/* 0 means jpg, 1 means bmp, default is 0=jpg */</span></span><br><span class="line">    <span class="keyword">int</span> filesize;</span><br><span class="line">    u8 *filedata = romfile_loadfile(<span class="string">"bootsplash.jpg"</span>, &amp;filesize);</span><br><span class="line">    <span class="keyword">if</span> (!filedata) &#123;</span><br><span class="line">        filedata = romfile_loadfile(<span class="string">"bootsplash.bmp"</span>, &amp;filesize);</span><br><span class="line">        <span class="keyword">if</span> (!filedata)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        type = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>This function will check the <code>CONFIG_BOOTSPLASH</code> and bootsplash image.</p>
<p>Secondly, we find that the <code>enable_bootsplash</code> will be called by <code>interactive_bootmenu</code> @ <code>src/boot.c</code>.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Show IPL option menu.</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">interactive_bootmenu(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// XXX - show available drives?</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"CONFIG_BOOTMENU: %d\n"</span>, CONFIG_BOOTMENU);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"show-boot-menu: %d\n"</span>, romfile_loadint(<span class="string">"etc/show-boot-menu"</span>, <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">if</span> (! CONFIG_BOOTMENU || !romfile_loadint(<span class="string">"etc/show-boot-menu"</span>, <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (get_keystroke(<span class="number">0</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">        ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *bootmsg = romfile_loadfile(<span class="string">"etc/boot-menu-message"</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">int</span> menukey = romfile_loadint(<span class="string">"etc/boot-menu-key"</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, bootmsg ?: <span class="string">"\nPress ESC for boot menu.\n\n"</span>);</span><br><span class="line">    <span class="built_in">free</span>(bootmsg);</span><br><span class="line"></span><br><span class="line">    u32 menutime = romfile_loadint(<span class="string">"etc/boot-menu-wait"</span>, DEFAULT_BOOTMENU_WAIT);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"menutime: %d\n"</span>, menutime);</span><br><span class="line">    enable_bootsplash();</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p>
<p>It seems that it is the function to provide the boot menu (i.e, booting from which boot device).<br>This function will also check the <code>CONFIG_BOOTMENU</code> and the file <code>etc/show-boot-menu</code>.<br>If we print the config before the first if condition, we will find that </p>
<p><img src="https://i.imgur.com/J0M7dAD.png" alt=""></p>
<p>Therefore, the <code>CONFIG_BOOTMENU</code> is 1 but <code>etc/show-boot-menu</code> is 0, so the <code>interactive_bootmenu</code> will return early without executing the rest of code including the <code>enable_bootsplash</code> method.</p>
<p>After did some <a href="https://github.com/qemu/qemu/blob/master/docs/specs/fw_cfg.txt" target="_blank" rel="noopener">researches</a>, qemu provide an option <code>-fw_cfg</code> to provide some file as</p>
<ul>
<li><code>-fw_cfg [name=]&lt;item_name&gt;,file=&lt;path&gt;</code>. or</li>
<li><code>-fw_cfg [name=]&lt;item_name&gt;,string=&lt;string&gt;</code></li>
</ul>
<p>So I revise the qemu command to<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -m 16M -boot a -fda Image -hda ../osdi.img -bios seabios/out/bios.bin -fw_cfg name=etc/show-boot-menu,string=1</span><br></pre></td></tr></table></figure></p>
<p>After that, the result became</p>
<p><img src="https://i.imgur.com/v1dMZr5.png" alt=""></p>
<p>It did enter the rest of code and ready to execute boot menu, and because the <code>enable_bootsplash</code> will check the image before load it, and we provide the bootsplash image as following.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -m 16M -boot a -fda Image -hda ../osdi.img -bios seabios/out/bios.bin -fw_cfg name=etc/show-boot-menu,string=1 -fw_cfg name=bootsplash.jpg,file=bootsplash.jpg</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.imgur.com/hwRLd1Z.png" alt=""></p>
<p>It work!</p>
<p>My friends also found that another qemu option <a href="https://manpages.debian.org/jessie/qemu-system-x86/qemu-system-x86_64.1.en.html" target="_blank" rel="noopener"><code>-boot</code></a> provide the same functionality.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -m 16M -boot order=a,menu=on,splash=bootsplash.jpg  -fda Image -hda ../osdi.img -bios seabios/out/bios.bin</span><br></pre></td></tr></table></figure></p>
<p>Which will be more clever and elegant!</p>
<h2 id="Lab2-3-Boot-the-hello-world-program"><a href="#Lab2-3-Boot-the-hello-world-program" class="headerlink" title="Lab2.3 - Boot the hello world program"></a>Lab2.3 - Boot the hello world program</h2><p>In this time, we will revise the kernel image structure and boot the given <code>hello</code>.<br>We will revise the image from<br><img src="https://i.imgur.com/DjL3gC2.png" alt=""><br>to<br><img src="https://i.imgur.com/biwIcIa.png" alt=""></p>
<h3 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h3><p>Of course we will revise the Makefile and build.sh.</p>
<p>Firstly, put the <code>hello.s</code> to <code>boot</code>, and revise the <code>boot/Makefile</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">all: bootsect hello setup</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">hello: hello.s</span><br><span class="line">	@$(AS) -o hello.o hello.s</span><br><span class="line">	@$(LD) $(LDFLAGS) -o hello hello.o</span><br><span class="line">	@objcopy -R .pdr -R .comment -R.note -S -O binary hello</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	@rm -f bootsect bootsect.o setup setup.o head.o hello hello.o</span><br></pre></td></tr></table></figure></p>
<p>Just add new rule for hello and remember to clean its object file when executing <code>make clean</code>.</p>
<p>Secondly, revise the <code>Makefile</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Image: boot/bootsect boot/hello boot/setup tools/system</span><br><span class="line">	@cp -f tools/system system.tmp</span><br><span class="line">	@strip system.tmp</span><br><span class="line">	@objcopy -O binary -R .note -R .comment system.tmp tools/kernel</span><br><span class="line">	@chmod +x tools/build.sh</span><br><span class="line">	@tools/build.sh boot/bootsect boot/hello boot/setup tools/kernel Image $(ROOT_DEV)</span><br><span class="line">	@rm system.tmp</span><br><span class="line">	@rm tools/kernel -f</span><br><span class="line">	@sync</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Update the Image <em>prerequisites</em> and add hello to the <code>tools/build.sh</code>parameter.</p>
<p>Thirdly, revise the <code>tools/build.sh</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># build.sh -- a shell version of build.c for the new bootsect.s &amp; setup.s</span><br><span class="line"># author: falcon &lt;wuzhangjin@gmail.com&gt;</span><br><span class="line"># update: 2008-10-10</span><br><span class="line"></span><br><span class="line">bootsect=$1</span><br><span class="line">hello=$2</span><br><span class="line">setup=$3</span><br><span class="line">system=$4</span><br><span class="line">IMAGE=$5</span><br><span class="line">root_dev=$6</span><br><span class="line"></span><br><span class="line"># Set the biggest sys_size</span><br><span class="line"># Changes from 0x20000 to 0x30000 by tigercn to avoid oversized code.</span><br><span class="line">SYS_SIZE=$((0x3000*16))</span><br><span class="line"></span><br><span class="line"># set the default &quot;device&quot; file for root image file</span><br><span class="line">if [ -z &quot;$root_dev&quot; ]; then</span><br><span class="line">	DEFAULT_MAJOR_ROOT=3</span><br><span class="line">	DEFAULT_MINOR_ROOT=1</span><br><span class="line">else</span><br><span class="line">	DEFAULT_MAJOR_ROOT=$&#123;root_dev:0:2&#125;</span><br><span class="line">	DEFAULT_MINOR_ROOT=$&#123;root_dev:2:3&#125;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># Write bootsect (512 bytes, one sector) to stdout</span><br><span class="line">[ ! -f &quot;$bootsect&quot; ] &amp;&amp; echo &quot;there is no bootsect binary file there&quot; &amp;&amp; exit -1</span><br><span class="line">dd if=$bootsect bs=512 count=1 of=$IMAGE 2&gt;&amp;1 &gt;/dev/null</span><br><span class="line"></span><br><span class="line"># Write hello(512bytes, one sector) to stdout</span><br><span class="line">[ ! -f &quot;$hello&quot; ] &amp;&amp; echo &quot;there is no hello binary file there&quot; &amp;&amp; exit -1</span><br><span class="line">dd if=$hello seek=1 bs=512 count=1 of=$IMAGE 2&gt;&amp;1 &gt;/dev/null</span><br><span class="line"></span><br><span class="line"># Write setup(4 * 512bytes, four sectors) to stdout</span><br><span class="line">[ ! -f &quot;$setup&quot; ] &amp;&amp; echo &quot;there is no setup binary file there&quot; &amp;&amp; exit -1</span><br><span class="line">dd if=$setup seek=2 bs=512 count=4 of=$IMAGE 2&gt;&amp;1 &gt;/dev/null</span><br><span class="line"></span><br><span class="line"># Write system(&lt; SYS_SIZE) to stdout</span><br><span class="line">[ ! -f &quot;$system&quot; ] &amp;&amp; echo &quot;there is no system binary file there&quot; &amp;&amp; exit -1</span><br><span class="line">system_size=`wc -c $system |cut -d&quot; &quot; -f1`</span><br><span class="line">[ $system_size -gt $SYS_SIZE ] &amp;&amp; echo &quot;the system binary is too big&quot; &amp;&amp; exit -1</span><br><span class="line">dd if=$system seek=6 bs=512 count=$((2888-1-1-4)) of=$IMAGE 2&gt;&amp;1 &gt;/dev/null</span><br><span class="line"></span><br><span class="line"># Set &quot;device&quot; for the root image file</span><br><span class="line">echo -ne &quot;\x$DEFAULT_MINOR_ROOT\x$DEFAULT_MAJOR_ROOT&quot; | dd ibs=1 obs=1 count=2 seek=508 of=$IMAGE conv=notrunc  2&gt;&amp;1 &gt;/dev/null</span><br></pre></td></tr></table></figure>
<p>Remember that at the <code>Makefile</code>, we put the hello as the second parameter, and we also need to update the parameter index of rest.</p>
<p>Link the <code>hello</code> to <code>Image</code>, <strong>order matter!</strong><br>We want to put the bootsect, hello, setup and system, so we must follow this order.</p>
<p>The hello contain 512 bytes and occupied 1 sector, that is the <code>bs</code> and <code>count</code> option for.</p>
<p>So far, we insert the hello to new image, and we are ready to boot it.</p>
<h3 id="How-OS-boot"><a href="#How-OS-boot" class="headerlink" title="How OS boot?"></a>How OS boot?</h3><p>At <code>boot/bootsect.s</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">	ljmp    $BOOTSEG, $_start</span><br><span class="line">_start:</span><br><span class="line">	mov	$BOOTSEG, %ax</span><br><span class="line">	mov	%ax, %ds</span><br><span class="line">	mov	$INITSEG, %ax</span><br><span class="line">	mov	%ax, %es</span><br><span class="line">	mov	$256, %cx</span><br><span class="line">	sub	%si, %si</span><br><span class="line">	sub	%di, %di</span><br><span class="line">	rep</span><br><span class="line">	movsw </span><br><span class="line">	ljmp	$INITSEG, $go</span><br></pre></td></tr></table></figure>
<ol>
<li>Long jump to <code>$BOOTSEG:$_start</code> when OS is loaded by BIOS.</li>
<li>Put <code>$BOOTSEG</code> to <code>%ds</code>, <code>$INITSEG</code> to <code>%es</code> and 256 to <code>%cx</code>.</li>
<li>Zero the <code>%si</code> and <code>%di</code>.</li>
<li><p>Repeat <code>movsw</code> until <code>%cx</code> is zero (i.e. copy itself to from <code>$BOOTSEG</code> to <code>$INITSEG</code>, total size is 512 bytes).</p>
<p> Because the counter of <code>rep</code> will decrease by 1 after executed, so the <code>movw</code> will execute 256 times!</p>
<p> <code>movw</code> will move one word (2 bytes in 16-bits CPU) from <code>%ds:%si</code> to <code>%es:%di</code>.</p>
<p> First step:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%ds = $BOOTSEG</span><br><span class="line">%si = 0</span><br><span class="line">%es = $INITSEG</span><br><span class="line">%di = 0</span><br><span class="line"></span><br><span class="line"># Copy from $BOOTSEG:0 to $INITSEG:0</span><br><span class="line">movw</span><br></pre></td></tr></table></figure>
<p> Second step:<br> Because the <code>%si</code> and <code>%di</code> will increase by 2 (bytes, one word in 16-bits CPU) after done it. So</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%ds = $BOOTSEG</span><br><span class="line">%si = 2</span><br><span class="line">%es = $INITSEG</span><br><span class="line">%di = 2</span><br><span class="line"></span><br><span class="line"># Copy from $BOOTSEG:2 to $INITSEG:2</span><br><span class="line">movw</span><br></pre></td></tr></table></figure>
<p> After 256 times, the <code>$BOOTSEG:0</code> - <code>$BOOTSEG:256</code> will copy to  <code>$INITSEG:0</code> - <code>$INITSEG:256</code>. That’s <code>bootsect</code> itself!</p>
</li>
<li><p>Long jump to <code>$INITSEG:$go</code>.</p>
</li>
</ol>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">go:	mov	%cs, %ax 			# after long jump, %cs become $INITSEG</span><br><span class="line">	mov	%ax, %ds</span><br><span class="line">	mov	%ax, %es</span><br><span class="line"># put stack at 0x9ff00.</span><br><span class="line">	mov	%ax, %ss</span><br><span class="line">	mov	$0xFF00, %sp		# arbitrary value &gt;&gt;512</span><br></pre></td></tr></table></figure>
<ol>
<li>Move <code>$INITSEG</code> to <code>%ds</code>, <code>%es</code> and <code>%ss</code>.<br> After long jump, the <code>%cs</code> will store the last segment it jump, that is <code>$INITSEG</code>.</li>
<li>Put the top of stack <code>%sp</code> to a huge address.</li>
</ol>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># load the setup-sectors directly after the bootblock.</span><br><span class="line"># Note that &apos;es&apos; is already set up.</span><br><span class="line">load_setup:</span><br><span class="line">	mov	$0x0000, %dx		# drive 0, head 0</span><br><span class="line">	mov	$0x0002, %cx		# sector 2, track 0</span><br><span class="line">	mov	$0x0200, %bx		# address = 512, in INITSEG</span><br><span class="line">	.equ    AX, 0x0200+SETUPLEN</span><br><span class="line">	mov     $AX, %ax		# service 2, nr of sectors</span><br><span class="line">	int	$0x13			# read it</span><br><span class="line">	jnc	ok_load_setup		# ok - continue</span><br><span class="line">	mov	$0x0000, %dx</span><br><span class="line">	mov	$0x0000, %ax		# reset the diskette</span><br><span class="line">	int	$0x13</span><br><span class="line">	jmp	load_setup</span><br></pre></td></tr></table></figure>
<ol>
<li>In this time, we want to read drive 0 (floppy), from 0 cylinder, 0 track, from <code>2</code>‘th sector and read <code>SETUPLEN</code> sectors, 0 head to memory based on address <code>$INITSEG:$0x0200</code>. (i.e. load the setup in memory)</li>
<li>If successfully read it, <code>%cf</code> will not be set, so that <code>jnc    ok_load_setup</code> will jump to <code>ok_load_setup</code>.</li>
<li>Otherwise, reset the disk and try again.</li>
</ol>
<hr>
<p><strong>Reference:</strong></p>
<h4 id="Drive-table"><a href="#Drive-table" class="headerlink" title="Drive table:"></a><a href="https://en.wikipedia.org/wiki/INT_13H" target="_blank" rel="noopener">Drive table</a>:</h4><table>
<thead>
<tr>
<th>Register value</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>DL = 00h</td>
<td>1st floppy disk ( “drive A:” )</td>
</tr>
<tr>
<td>DL = 01h</td>
<td>2nd floppy disk ( “drive B:” )</td>
</tr>
<tr>
<td>DL = 80h</td>
<td>1st hard disk</td>
</tr>
<tr>
<td>DL = 81h</td>
<td>2nd hard disk</td>
</tr>
<tr>
<td>DL = e0h</td>
<td>CD/DVD</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="INT-13h-AH-02h-Read-Sectors-From-Drive"><a href="#INT-13h-AH-02h-Read-Sectors-From-Drive" class="headerlink" title="INT 13h, AH = 02h: Read Sectors From Drive"></a>INT 13h, AH = 02h: <a href="https://en.wikipedia.org/wiki/INT_13H" target="_blank" rel="noopener">Read Sectors From Drive</a></h4><p><strong>Parameter:</strong></p>
<table>
<thead>
<tr>
<th>Register</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>AH</td>
<td>02h</td>
</tr>
<tr>
<td>AL</td>
<td>Sectors To Read Count</td>
</tr>
<tr>
<td>CH</td>
<td>Cylinder</td>
</tr>
<tr>
<td>CL</td>
<td>Sector</td>
</tr>
<tr>
<td>DH</td>
<td>Head</td>
</tr>
<tr>
<td>DL</td>
<td>Drive</td>
</tr>
<tr>
<td>ES:BX</td>
<td>Buffer Address Pointer</td>
</tr>
</tbody>
</table>
<p><strong>Results:</strong></p>
<table>
<thead>
<tr>
<th>Register</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>CF</td>
<td>Set On Error, Clear If No Error</td>
</tr>
<tr>
<td>AH</td>
<td>Return Code</td>
</tr>
<tr>
<td>AL</td>
<td>Actual Sectors Read Count</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="INT-13h-AH-00h-Reset-Disk-System"><a href="#INT-13h-AH-00h-Reset-Disk-System" class="headerlink" title="INT 13h, AH = 00h: Reset Disk System"></a>INT 13h, AH = 00h: <a href="https://en.wikipedia.org/wiki/INT_13H" target="_blank" rel="noopener">Reset Disk System</a></h4><p><strong>Parameter:</strong></p>
<table>
<thead>
<tr>
<th>Register</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>AH</td>
<td>00h</td>
</tr>
<tr>
<td>DL</td>
<td>Drive (bit 7 set means reset both hard and floppy disks)</td>
</tr>
</tbody>
</table>
<p><strong>Results:</strong></p>
<table>
<thead>
<tr>
<th>Register</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>CF</td>
<td>Set on error</td>
</tr>
<tr>
<td>AH</td>
<td>Return Code</td>
</tr>
</tbody>
</table>
<hr>
<p>We can imitate the procedure to…<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">	.equ HELLOLEN, 1		# nr of hello-sectors</span><br><span class="line">	.equ HELLOSEG, 0x0100	# hello starts here</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">go:	mov	%cs, %ax 			# after long jump, %cs become $INITSEG</span><br><span class="line">	mov	%ax, %ds</span><br><span class="line">	mov	%ax, %es</span><br><span class="line"># put stack at 0x9ff00.</span><br><span class="line">	mov	%ax, %ss</span><br><span class="line">	mov	$0xFF00, %sp		# arbitrary value &gt;&gt;512</span><br><span class="line">    </span><br><span class="line"># Lab 2</span><br><span class="line">load_hello:</span><br><span class="line">   mov	$0x0000, %dx		# drive 0, head 0</span><br><span class="line">   mov	$0x0002, %cx		# sector 2, track 0</span><br><span class="line">   mov $HELLOSEG, %ax		# segment</span><br><span class="line">   mov %ax, %es</span><br><span class="line">   mov	$0x0000, %bx		# offset, address = 0x0100</span><br><span class="line">   .equ    AX, 0x0200+HELLOLEN</span><br><span class="line">   mov     $AX, %ax			# service 2, nr of sectors</span><br><span class="line">   int	$0x13				# read it</span><br><span class="line">   jnc	ok_load_hello		# ok - continue</span><br><span class="line">   mov	$0x0000, %dx</span><br><span class="line">   mov	$0x0000, %ax		# reset the diskette</span><br><span class="line">   int	$0x13</span><br><span class="line">   jmp	load_hello</span><br><span class="line"></span><br><span class="line">ok_load_hello:</span><br><span class="line">   ljmp $HELLOSEG, $0 # Jump to hello</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p><img src="https://i.imgur.com/ejJFhn5.png" alt=""></p>
<p>It works!</p>
<hr>
<h2 id="Lab2-4-Multiboot-support"><a href="#Lab2-4-Multiboot-support" class="headerlink" title="Lab2.4 - Multiboot support"></a>Lab2.4 - Multiboot support</h2><p>In this experiment, you need to implement a simple keyboard character reader that when user:</p>
<ul>
<li><p>Press ‘1’, it boots the linux-0.11 Image(just like lab1).</p>
</li>
<li><p>Press ‘2’, it boots the hello world program.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">go:	mov	%cs, %ax 			# after long jump, %cs become $INITSEG</span><br><span class="line">	mov	%ax, %ds</span><br><span class="line">	mov	%ax, %es</span><br><span class="line"># put stack at 0x9ff00.</span><br><span class="line">	mov	%ax, %ss</span><br><span class="line">	mov	$0xFF00, %sp		# arbitrary value &gt;&gt;512</span><br><span class="line">    </span><br><span class="line">boot_menu:</span><br><span class="line">   # Print some inane message</span><br><span class="line">   mov	$0x03, %ah		# read cursor pos</span><br><span class="line">   xor	%bh, %bh		# page number</span><br><span class="line">   int	$0x10</span><br><span class="line">   </span><br><span class="line">   mov	$21, %cx		# string length</span><br><span class="line">   mov	$0x000D, %bx		# page 0, attribute 7 (normal)</span><br><span class="line">   #lea	option, %bp</span><br><span class="line">   mov     $option, %bp		# point to message</span><br><span class="line">   mov	$0x1301, %ax		# write string, move cursor</span><br><span class="line">   int	$0x10</span><br><span class="line"></span><br><span class="line">   mov $0x00, %ah</span><br><span class="line">   int $0x16</span><br><span class="line"></span><br><span class="line">   cmp $49, %al				# 1 ascii</span><br><span class="line">   je load_setup</span><br><span class="line">   cmp $50, %al				# 2 ascii</span><br><span class="line">   je load_hello</span><br><span class="line">   jmp boot_menu</span><br><span class="line"></span><br><span class="line">   ...</span><br><span class="line"> </span><br><span class="line">msg1:</span><br><span class="line">	.byte 13,10</span><br><span class="line">	.ascii &quot;Loading system ...&quot;</span><br><span class="line">	.byte 13,10,13,10</span><br><span class="line"></span><br><span class="line">option:</span><br><span class="line">	.byte 13,10</span><br><span class="line">	.ascii &quot;1) linux, 2) hello&quot;</span><br><span class="line">	.byte 13,10,13,10</span><br></pre></td></tr></table></figure>
<ol>
<li>We locate the cursor.</li>
<li>Print the string to show the boot option.</li>
<li>Read the keyboard</li>
<li>Goto <code>load_setup</code> if pressing 1, goto <code>load_hello</code> if pressing 2.</li>
<li>Otherwise, go to <code>boot_menu</code> again.</li>
</ol>
<hr>
<p><strong>Reference:</strong></p>
<h4 id="INT-10h-AH-03h-Get-cursor-position-and-shape"><a href="#INT-10h-AH-03h-Get-cursor-position-and-shape" class="headerlink" title="INT 10h, AH = 03h: Get cursor position and shape"></a>INT 10h, AH = 03h: <a href="https://en.wikipedia.org/wiki/INT_10H" target="_blank" rel="noopener">Get cursor position and shape</a></h4><p><strong>Parameter:</strong></p>
<table>
<thead>
<tr>
<th>Register</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>AH</td>
<td>03h</td>
</tr>
<tr>
<td>BH</td>
<td>Page Number</td>
</tr>
</tbody>
</table>
<p><strong>Results:</strong></p>
<table>
<thead>
<tr>
<th>Register</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>AX = 0</td>
<td></td>
</tr>
<tr>
<td>CH</td>
<td>Start scan line</td>
</tr>
<tr>
<td>CL</td>
<td>End scan line</td>
</tr>
<tr>
<td>DH</td>
<td>Row</td>
</tr>
<tr>
<td>DL</td>
<td>Column</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="INT-10h-AH-13h-Write-string"><a href="#INT-10h-AH-13h-Write-string" class="headerlink" title="INT 10h, AH = 13h: Write string"></a>INT 10h, AH = 13h: <a href="https://en.wikipedia.org/wiki/INT_10H" target="_blank" rel="noopener">Write string</a></h4><p><strong>Parameter:</strong></p>
<table>
<thead>
<tr>
<th>Register</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>AH</td>
<td>13h</td>
</tr>
<tr>
<td>AL</td>
<td>Write mode</td>
</tr>
<tr>
<td>BH</td>
<td>Page Number</td>
</tr>
<tr>
<td>BL</td>
<td>Color</td>
</tr>
<tr>
<td>CX</td>
<td>String length</td>
</tr>
<tr>
<td>DH</td>
<td>Row</td>
</tr>
<tr>
<td>DL</td>
<td>Column</td>
</tr>
<tr>
<td>ES:EP</td>
<td>Offset of string</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="INT-16h-AH-00h-Read-keystroke"><a href="#INT-16h-AH-00h-Read-keystroke" class="headerlink" title="INT 16h, AH = 00h: Read keystroke"></a>INT 16h, AH = 00h: <a href="https://en.wikipedia.org/wiki/INT_16H" target="_blank" rel="noopener">Read keystroke</a></h4><p><strong>Parameter:</strong></p>
<table>
<thead>
<tr>
<th>Register</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>AH</td>
<td>00h</td>
</tr>
</tbody>
</table>
<p><strong>Results:</strong></p>
<table>
<thead>
<tr>
<th>Register</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>AH</td>
<td>Scan code of the key pressed down</td>
</tr>
<tr>
<td>AL</td>
<td>ASCII character of the button pressed</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="BIOS-color"><a href="#BIOS-color" class="headerlink" title="BIOS color:"></a><a href="https://en.wikipedia.org/wiki/BIOS_color_attributes" target="_blank" rel="noopener">BIOS color</a>:</h4><table>
<thead>
<tr>
<th>Hex</th>
<th>Color</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Black</td>
</tr>
<tr>
<td>1</td>
<td>Blue</td>
</tr>
<tr>
<td>2</td>
<td>Green</td>
</tr>
<tr>
<td>3</td>
<td>Cyan</td>
</tr>
<tr>
<td>4</td>
<td>Red</td>
</tr>
<tr>
<td>5</td>
<td>Magenta</td>
</tr>
<tr>
<td>6</td>
<td>Brown</td>
</tr>
<tr>
<td>7</td>
<td>Light Gray</td>
</tr>
<tr>
<td>8</td>
<td>Dark Gray</td>
</tr>
<tr>
<td>9</td>
<td>Light Blue</td>
</tr>
<tr>
<td>A</td>
<td>Light Green</td>
</tr>
<tr>
<td>B</td>
<td>Light Cyan</td>
</tr>
<tr>
<td>C</td>
<td>Light Red</td>
</tr>
<tr>
<td>D</td>
<td>Light Magenta</td>
</tr>
<tr>
<td>E</td>
<td>Yellow</td>
</tr>
<tr>
<td>F</td>
<td>White</td>
</tr>
</tbody>
</table>
<hr>
<h4 id="ASCII"><a href="#ASCII" class="headerlink" title="ASCII:"></a><a href="https://en.wikipedia.org/wiki/ASCII" target="_blank" rel="noopener">ASCII</a>:</h4><table>
<thead>
<tr>
<th>Dec</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>Line feed (\n)</td>
</tr>
<tr>
<td>49</td>
<td>1</td>
</tr>
<tr>
<td>50</td>
<td>2</td>
</tr>
</tbody>
</table>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">load_setup:</span><br><span class="line">	mov	$0x0000, %dx		# drive 0, head 0</span><br><span class="line">	mov	$0x0003, %cx		# sector 3, track 0</span><br><span class="line">	mov	$0x0200, %bx		# address = 512, in INITSEG</span><br><span class="line">	.equ    AX, 0x0200+SETUPLEN</span><br><span class="line">	mov     $AX, %ax		# service 2, nr of sectors</span><br><span class="line">	int	$0x13			# read it</span><br><span class="line">	jnc	ok_load_setup		# ok - continue</span><br><span class="line">	mov	$0x0000, %dx</span><br><span class="line">	mov	$0x0000, %ax		# reset the diskette</span><br><span class="line">	int	$0x13</span><br><span class="line">	jmp	load_setup</span><br></pre></td></tr></table></figure>
<p><code>load_hello</code> remain the same, but the setup is located at 3rd sector, so we revise the <code>%cl</code> to 0x03.</p>
<p>It seems that all work are done. However, after making and run it.</p>
<p><img src="https://i.imgur.com/KB682J1.png" alt=""></p>
<p>Hello runs pretty well.</p>
<p>After press 1, I want to load the setup, but the OS begin to reboot continuously.</p>
<p>It seems that we didn’t run the <code>ljmp    $SETUPSEG, $0</code>.<br>Thus, we must continue to trace the rest of code.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ok_load_setup:</span><br><span class="line"></span><br><span class="line"># Get disk drive parameters, specifically nr of sectors/track</span><br><span class="line"></span><br><span class="line">	mov	$0x00, %dl</span><br><span class="line">	mov	$0x0800, %ax		# AH=8 is get drive parameters</span><br><span class="line">	int	$0x13</span><br><span class="line">	mov	$0x00, %ch</span><br><span class="line">	#seg cs</span><br><span class="line">	mov	%cx, %cs:sectors+0	# %cs means sectors is in %cs</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<ol>
<li>Get sectors of track.</li>
<li>Set <code>%ch</code> (<code>%cx[15:8]</code>) to <code>0x00</code>.</li>
<li>Because we boot from floppy (<code>%dl</code> = 0), and its maximum sectors per track will not exceed 256 (18 sectors per track normally), so <code>%cx[7:6]</code> will be <code>0</code>.</li>
<li>Move <code>%cx</code> to <code>sectors</code>.</li>
</ol>
<hr>
<p><strong>Reference:</strong></p>
<h4 id="INT-13h-AH-08h-Read-Drive-Parameters"><a href="#INT-13h-AH-08h-Read-Drive-Parameters" class="headerlink" title="INT 13h, AH = 08h: Read Drive Parameters"></a>INT 13h, AH = 08h: <a href="https://en.wikipedia.org/wiki/INT_13H" target="_blank" rel="noopener">Read Drive Parameters</a></h4><p><strong>Parameter:</strong></p>
<table>
<thead>
<tr>
<th>Register</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>AH</td>
<td>08h</td>
</tr>
<tr>
<td>DL</td>
<td>drive index</td>
</tr>
<tr>
<td>ES:DI</td>
<td>set to 0000h:0000h to work around some buggy BIOS</td>
</tr>
</tbody>
</table>
<p><strong>Results:</strong></p>
<table>
<thead>
<tr>
<th>Register</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>CF</td>
<td>Set On Error, Clear If No Error</td>
</tr>
<tr>
<td>AH</td>
<td>Return Code</td>
</tr>
<tr>
<td>DL</td>
<td>number of hard disk drives</td>
</tr>
<tr>
<td>DH</td>
<td>logical last index of heads = number_of - 1 (because index starts with 0)</td>
</tr>
<tr>
<td>CX</td>
<td>[7:6][15:8] logical last index of cylinders = number_of - 1 (because index starts with 0)<br>[5:0] logical last index of sectors per track = number_of (because index starts with 1)</td>
</tr>
<tr>
<td>BL</td>
<td>drive type (only AT/PS2 floppies)</td>
</tr>
<tr>
<td>ES:DI</td>
<td>pointer to drive parameter table (only for floppies)</td>
</tr>
</tbody>
</table>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ok_load_setup:</span><br><span class="line">   ...</span><br><span class="line">	mov	$SYSSEG, %ax</span><br><span class="line">	mov	%ax, %es		# segment of 0x010000</span><br><span class="line">	call	read_it</span><br><span class="line">	call	kill_motor</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>
<p>Put <code>$SYSSEG</code> in <code>%es</code>, and call read_it.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">read_it:</span><br><span class="line">	mov	%es, %ax</span><br><span class="line">	test	$0x0fff, %ax</span><br><span class="line">die:	jne 	die			# es must be at 64kB boundary</span><br><span class="line">	xor 	%bx, %bx		# bx is starting address within segment</span><br></pre></td></tr></table></figure>
<ol>
<li><code>TEST</code> <code>0x0fff</code> and <code>0x1000</code>. <code>TEST</code> is bitwise <code>AND</code> and result of <code>TEST</code> is <code>0</code>, <code>ZF</code> is set to <code>1</code>. <a href="https://en.wikipedia.org/wiki/TEST_(x86_instruction" target="_blank" rel="noopener">ref</a>)</li>
<li><code>JNE</code> will jump when <code>ZF</code> is <code>0</code>, so it will continue executing the next instruction. <a href="https://en.wikibooks.org/wiki/X86_Assembly/Control_Flow#Jump_Instructions" target="_blank" rel="noopener">ref</a></li>
<li>Zero <code>%bx</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rp_read:</span><br><span class="line">	mov 	%es, %ax</span><br><span class="line"> 	cmp 	$ENDSEG, %ax		# have we loaded all yet?</span><br><span class="line">	jb	ok1_read</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>
<ol>
<li>Put <code>%es</code> to <code>%ax</code> (<code>$SYSSEG</code>).</li>
<li>Compare <code>$ENGSEG</code>(<code>0x4000</code>) and <code>%ax</code> (<code>0x1000</code>).</li>
<li>In AT&amp;T syntax, <code>%ax</code> will subtract <code>$ENGSEG</code>. Result is <code>0xD000</code>. <code>SF</code> and <code>CF</code> will be set. <a href="https://en.wikibooks.org/wiki/X86_Assembly/Control_Flow#Comparison_Instructions" target="_blank" rel="noopener">ref</a></li>
<li>Because <code>jb</code> will jump when <code>CF</code> is 1, so jump to <code>ok1_read</code>. <a href="https://en.wikibooks.org/wiki/X86_Assembly/Control_Flow#Jump_Instructions" target="_blank" rel="noopener">ref</a></li>
<li>Otherwise, return to last callee.</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sread:	.word 1+ SETUPLEN	# sectors read of current track</span><br><span class="line">...</span><br><span class="line">ok1_read:</span><br><span class="line">	#seg cs</span><br><span class="line">	mov	%cs:sectors+0, %ax</span><br><span class="line">	sub	sread, %ax</span><br><span class="line">	mov	%ax, %cx</span><br><span class="line">	shl	$9, %cx</span><br><span class="line">	add	%bx, %cx</span><br><span class="line">	jnc 	ok2_read</span><br><span class="line">	je 	ok2_read</span><br><span class="line">	xor 	%ax, %ax</span><br><span class="line">	sub 	%bx, %ax</span><br><span class="line">	shr 	$9, %ax</span><br></pre></td></tr></table></figure>
<ol>
<li>Move <code>sectors</code> to <code>%ax</code> and subtract <code>sread</code>. That is un-read sectors.</li>
<li>Calculate the total bytes of un-read sectors (512 bytes per sector)  to <code>%cx</code></li>
<li>If not greater or eqaul to $2^{16}$ (maximum register capacity), goto <code>ok2_read</code>.</li>
<li>Otherwise, count the maximum sectors can read (<code>%ax</code>).</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ok2_read:</span><br><span class="line">	call 	read_track</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">read_track:</span><br><span class="line">	push	%ax</span><br><span class="line">	push	%bx</span><br><span class="line">	push	%cx</span><br><span class="line">	push	%dx</span><br><span class="line">	mov	track, %dx</span><br><span class="line">	mov	sread, %cx</span><br><span class="line">	inc	%cx</span><br><span class="line">	mov	%dl, %ch</span><br><span class="line">	mov	head, %dx</span><br><span class="line">	mov	%dl, %dh</span><br><span class="line">	mov	$0, %dl</span><br><span class="line">	and	$0x0100, %dx</span><br><span class="line">	mov	$2, %ah</span><br><span class="line">	int	$0x13</span><br><span class="line">	jc	bad_rt</span><br><span class="line">	pop	%dx</span><br><span class="line">	pop	%cx</span><br><span class="line">	pop	%bx</span><br><span class="line">	pop	%ax</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>
<ol>
<li>Store all register.</li>
<li>In this time, we want to read drive 0 (floppy), from 0 cylinder, 0 track, from <code>1+SETUPLEN+1</code>‘th sector and read <code>%al</code> un-read sectors, 0 head to memory based on address <code>$SYSSEG:0x0000</code>. (i.e. load the system in memory)</li>
<li>If failed, <code>%cf</code> will be set, so that <code>jc    bad_rt</code> will jump to <code>bad_rt</code>.</li>
<li>Load all registers.</li>
</ol>
<p>At this very moment, we have already known the error may come from here. Because the system is located at <code>1 + 1 + 1 + SETUPLEN</code>, so we <strong>must</strong> change <code>sread</code> to <code>1 + 1 + SETUPLEN</code>.</p>
<hr>
<p><strong>Reference:</strong></p>
<h4 id="INT-13h-AH-02h-Read-Sectors-From-Drive-1"><a href="#INT-13h-AH-02h-Read-Sectors-From-Drive-1" class="headerlink" title="INT 13h, AH = 02h: Read Sectors From Drive"></a>INT 13h, AH = 02h: <a href="https://en.wikipedia.org/wiki/INT_13H" target="_blank" rel="noopener">Read Sectors From Drive</a></h4><p><strong>Parameter:</strong></p>
<table>
<thead>
<tr>
<th>Register</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>AH</td>
<td>02h</td>
</tr>
<tr>
<td>AL</td>
<td>Sectors To Read Count</td>
</tr>
<tr>
<td>CH</td>
<td>Cylinder</td>
</tr>
<tr>
<td>CL</td>
<td>Sector</td>
</tr>
<tr>
<td>DH</td>
<td>Head</td>
</tr>
<tr>
<td>DL</td>
<td>Drive</td>
</tr>
<tr>
<td>ES:BX</td>
<td>Buffer Address Pointer</td>
</tr>
</tbody>
</table>
<p><strong>Results:</strong></p>
<table>
<thead>
<tr>
<th>Register</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>CF</td>
<td>Set On Error, Clear If No Error</td>
</tr>
<tr>
<td>AH</td>
<td>Return Code</td>
</tr>
<tr>
<td>AL</td>
<td>Actual Sectors Read Count</td>
</tr>
</tbody>
</table>
<hr>
<p>After change <code>sread</code> to <code>1 + 1 + SETUP</code>, it works!</p>
<p><img src="https://i.imgur.com/WGZwVkx.png" alt=""></p>
<hr>
<h2 id="Questions"><a href="#Questions" class="headerlink" title="Questions"></a>Questions</h2><ol>
<li>What’s the meaning of ljmp $BOOTSEG, $_start(boot/bootsect.s)? What is the memory address of the beginning of bootsect.s? What is the value of $_start? From above questions, could you please clearly explain how do you jump to the beginning of hello image?<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -D -mi386 -Maddr16,data16 boot/bootsect.o</span><br></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>![](https://i.imgur.com/lDWVVAr.png)
</code></pre><ol start="2">
<li><p>What’s the purpose of es register when the cpu is performing int $0x13 with AH=0x2h?</p>
<ul>
<li>base segment of memory address that put read sectors </li>
</ul>
</li>
<li><p>Please change the Hello program’s font color to another</p>
<ul>
<li>Change <code>%bl</code> register.</li>
</ul>
</li>
<li><p>If we would like to swap the position of hello and setup in the Image. Where do we need to modify in tools/build.sh and bootsect.s?</p>
<ul>
<li>The order of Image at <code>tools/build.sh</code></li>
<li>The starting sector want to read when perform int 13h with AH=02h.</li>
</ul>
</li>
<li><p>Please trace the SeaBIOS code. What are the first and the last instruction of the SeaBIOS? Where are they?</p>
<ul>
<li>First instruction: <code>reset_vector</code> @ <code>src/romlayout.S</code></li>
<li>Last instruction:<ul>
<li><code>call_boot_entry</code> @ <code>src/boot.c</code> in C</li>
<li><code>__farcall16</code> @ <code>src/romlayout.S</code> in asm</li>
</ul>
</li>
</ul>
</li>
</ol>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/course/" rel="tag"># course</a>
          
            <a href="/tags/os/" rel="tag"># os</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/12/Permutations/" rel="next" title="Permutations">
                <i class="fa fa-chevron-left"></i> Permutations
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/03/19/Combination-Sum/" rel="prev" title="Combination-Sum">
                Combination-Sum <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Eric Huang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#OSDI-lab-II"><span class="nav-number">1.</span> <span class="nav-text">OSDI lab II</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Objective"><span class="nav-number">1.1.</span> <span class="nav-text">Objective</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lab2-1-Build-SEABIOS-add-some-message-before-system-startup"><span class="nav-number">1.2.</span> <span class="nav-text">Lab2.1 - Build SEABIOS, add some message before system startup</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lab2-2-Add-image-before-system-startup"><span class="nav-number">1.3.</span> <span class="nav-text">Lab2.2 - Add image before system startup</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lab2-3-Boot-the-hello-world-program"><span class="nav-number">1.4.</span> <span class="nav-text">Lab2.3 - Boot the hello world program</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Makefile"><span class="nav-number">1.4.1.</span> <span class="nav-text">Makefile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-OS-boot"><span class="nav-number">1.4.2.</span> <span class="nav-text">How OS boot?</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Drive-table"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">Drive table:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#INT-13h-AH-02h-Read-Sectors-From-Drive"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">INT 13h, AH = 02h: Read Sectors From Drive</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#INT-13h-AH-00h-Reset-Disk-System"><span class="nav-number">1.4.2.3.</span> <span class="nav-text">INT 13h, AH = 00h: Reset Disk System</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lab2-4-Multiboot-support"><span class="nav-number">1.5.</span> <span class="nav-text">Lab2.4 - Multiboot support</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#INT-10h-AH-03h-Get-cursor-position-and-shape"><span class="nav-number">1.5.0.1.</span> <span class="nav-text">INT 10h, AH = 03h: Get cursor position and shape</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#INT-10h-AH-13h-Write-string"><span class="nav-number">1.5.0.2.</span> <span class="nav-text">INT 10h, AH = 13h: Write string</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#INT-16h-AH-00h-Read-keystroke"><span class="nav-number">1.5.0.3.</span> <span class="nav-text">INT 16h, AH = 00h: Read keystroke</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BIOS-color"><span class="nav-number">1.5.0.4.</span> <span class="nav-text">BIOS color:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ASCII"><span class="nav-number">1.5.0.5.</span> <span class="nav-text">ASCII:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#INT-13h-AH-08h-Read-Drive-Parameters"><span class="nav-number">1.5.0.6.</span> <span class="nav-text">INT 13h, AH = 08h: Read Drive Parameters</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#INT-13h-AH-02h-Read-Sectors-From-Drive-1"><span class="nav-number">1.5.0.7.</span> <span class="nav-text">INT 13h, AH = 02h: Read Sectors From Drive</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Questions"><span class="nav-number">1.6.</span> <span class="nav-text">Questions</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Eric Huang</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.7.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=6.7.0"></script>

  <script src="/js/src/motion.js?v=6.7.0"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=6.7.0"></script>



  
  <script src="/js/src/scrollspy.js?v=6.7.0"></script>
<script src="/js/src/post-details.js?v=6.7.0"></script>



  


  <script src="/js/src/bootstrap.js?v=6.7.0"></script>



  
  





  





  

  

  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: "AMS"
      }
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
      for (i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<style>
.MathJax_Display {
  overflow: auto hidden;
}
</style>

    
  


  

  

  

  

  

  

  

  

</body>
</html>
